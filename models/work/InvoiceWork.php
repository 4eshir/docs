<?php

namespace app\models\work;

use app\models\common\Invoice;
use app\models\work\EntryWork;
use app\models\work\InvoiceEntryWork;
use app\models\work\CompanyWork;
use yii\helpers\Html;
use Yii;


class InvoiceWork extends Invoice
{
	public $objects; //записи об объектах
    public $documentFile; //документ основания

	public function rules()
    {
        return [
            [['documentFile'], 'file', 'extensions' => 'xls, xlsx, doc, docx, zip, rar, 7z, tag, pdf', 'skipOnEmpty' => true],
            [['number', 'contractor_id', 'date_product', 'date_invoice'], 'required'],
            [['contractor_id', 'type'], 'integer'],
            [['date_product', 'date_invoice'], 'safe'],
            [['number'], 'string', 'max' => 15],
            [['document'], 'string', 'max' => 1000],
            [['contractor_id'], 'exist', 'skipOnError' => true, 'targetClass' => Company::className(), 'targetAttribute' => ['contractor_id' => 'id']],
        ];
    }

    public function attributeLabels()
    {
        return [
            'number' => 'Номер документа',
            'contractor_id' => 'Контрагент',
            'contractString' => 'Контрагент',
            'date' => 'Дата приема товара в накладной',
            'type' => 'Type',
            'entries' => '',
            'documentFile' => 'Документ основания'
        ];
    }

    public function getContractString()
    {
        $contractor = CompanyWork::find()->where(['id' => $this->contractor_id])->one();
        return Html::a($contractor->name, \yii\helpers\Url::to(['company/view', 'id' => $contractor->id]));
    }

    public function getEntries()
    {
        $entries = InvoiceEntryWork::find()->where(['invoice_id' => $this->id])->all();
        $result = '';
        foreach ($entries as $entry)
        {
            $result .= '<b>'.$entry->entryWork->amount.'</b> '.$entry->entryWork->objectWork->name.'<br>';
            for ($i = $entry->entryWork->object_id; $i < $entry->entryWork->object_id + $entry->entryWork->amount; $i++)
            {
                $obj = MaterialObjectWork::find()->where(['id' => $i])->one();
                $result .= Html::a($obj->name, \yii\helpers\Url::to(['material-object/view', 'id' => $obj->id])).' - '.($i - $entry->entryWork->object_id + 1).'<br>';
            }
            $result .= '<hr style="border-top: 1px solid gray; margin-top: 5px; margin-bottom: 5px">';
        }
        return $result;
    }

    public function uploadScanFile()
    {
        $path = '@app/upload/files/invoice/document/';
        $date = $this->local_date;
        $new_date = '';
        $filename = '';
        for ($i = 0; $i < strlen($date); ++$i)
            if ($date[$i] != '-')
                $new_date = $new_date.$date[$i];
        if ($this->company->short_name !== '')
        {
            $filename = 'Вх.'.$new_date.'_'.$this->local_number.'_'.$this->company->short_name.'_'.$this->document_theme;
        }
        else
        {
            $filename = 'Вх.'.$new_date.'_'.$this->local_number.'_'.$this->company->name.'_'.$this->document_theme;
        }
        $res = mb_ereg_replace('[ ]{1,}', '_', $filename);
        $res = mb_ereg_replace('[^а-яА-Я0-9._]{1}', '', $res);
        $res = FileWizard::CutFilename($res);
        $this->scan = $res.'.'.$this->scanFile->extension;
        $this->scanFile->saveAs( $path.$res.'.'.$this->scanFile->extension);
    }

    public function afterSave($insert, $changedAttributes)
    {
    	parent::afterSave($insert, $changedAttributes); // TODO: Change the autogenerated stub

    	if ($this->objects !== null && $this->objects[0]->name != '')
    	{
            //сохраняем все объекты из динамической формы
    		foreach ($this->objects as $object)
            {
                //если ОС (нет количества)
                if ($object->amount == "") $object->amount = 1;

                $objId = -1;
                for ($i = 0; $i < $object->amount; $i++)
                {
                    $newObject = new MaterialObjectWork($object);
                    $newObject->number = $this->number;
                    $newObject->save();
                    if ($objId == -1) $objId = $newObject->id;
                }

                //создаем запись для накладной
                $entry = EntryWork::find()->where(['object_id' => $object->id])->one();
                if ($entry == null) $entry = new EntryWork();
                $entry->object_id = $objId;
                $entry->amount = $object->amount;
                $entry->fill();
                $entry->save();

                //связываем запись и накладную/акт
                $invoiceEntry = InvoiceEntryWork::find()->where(['invoice_id' => $this->id])->andWhere(['entry_id' => $entry->id])->one();
                if ($invoiceEntry == null) $invoiceEntry = new InvoiceEntryWork();
                $invoiceEntry->invoice_id = $this->id;
                $invoiceEntry->entry_id = $entry->id;
                $invoiceEntry->save();
            }


    	}
    }
}
